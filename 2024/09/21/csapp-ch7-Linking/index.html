
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>csapp:ch7_Linking | Frun1na &#39;s blog</title>
    <meta name="author" content="Frun1na" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>FRUN1NA &#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;FRUN1NA &#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>csapp:ch7_Linking</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/9/21
        </span>
        
        
    </div>
    
    <div class="content" v-pre>
        <h1 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h1><span id="more"></span>

<p>首先是这张图</p>
<p><img src="https://frun1na.netlify.app//image-20240911155747108.png"></p>
<p>静态链接就是输入可重定位目标文件和一些命令行参数，输出可执行文件的过程。</p>
<p>为什么需要链接？修改某一个源码之后可以编译这一个文件，并链接。而不是重新编译所有文件。</p>
<p>为了完成链接，链接器要完成两个任务：符号解析，重定位</p>
<h2 id="目标文件"><a href="#目标文件" class="headerlink" title="目标文件"></a>目标文件</h2><p>有三种形式：</p>
<p><strong>可重定位目标文件（.o文件）</strong></p>
<p>每个.o文件由对应的.c文件生成</p>
<p>它包含了二进制的代码和数据，可以和其他可重定位目标文件链接，生成可执行目标文件。</p>
<p><strong>可执行目标文件（.out）文件</strong></p>
<p>包含二进制的代码和数据，可以直接复制到内存中然后执行。</p>
<p><strong>共享目标文件（.so）文件</strong></p>
<p>特殊类型的可重定位目标文件，可以在加载时或运行时加载到内存并动态链接</p>
<p>windows上称为<strong>动态链接库</strong>（.dll）</p>
<h2 id="可执行可连接的格式"><a href="#可执行可连接的格式" class="headerlink" title="可执行可连接的格式"></a>可执行可连接的格式</h2><p>Executable and Linkable Format(ELF)</p>
<p>二进制格式</p>
<p>为上面三种目标文件提供一种统一的格式封装</p>
<p>通用名称：ELF二进制文件</p>
<p><strong>ELF目标文件格式</strong></p>
<img src="https://frun1na.netlify.app//20240918125214.png" style="zoom:50%;" />

<p>其中包含了如图所示的几个部分：</p>
<p>1.ELF头</p>
<p>​		包含了字大小、字节顺序、ELF头的大小、目标文件类型、机器类型、节头表的偏移量等等。</p>
<p>2.程序头部表（段头部表）</p>
<p>​		包含：页大小、虚拟地址内存段（节）、段大小的信息</p>
<p>​		可执行目标文件中必须存在此部分</p>
<p>3..text节</p>
<p>​		已编译程序的机器代码</p>
<p>4..rodata节</p>
<p>​		只读数据：跳转表等</p>
<p>5.data节</p>
<p>​		已初始化的全局和静态C变量，局部变量不会保存在这里</p>
<p>6.bss节		</p>
<p>​		未初始化的全局和静态C变量，以及初始化为0的。</p>
<p>​		原名：“块存储开始”</p>
<p>​		可以把它看做是“更好的节省空间”的缩写</p>
<p>​		有节头信息，但不占空间，只有在加载时，才会在内存分配空间。</p>
<p>7.symtab节</p>
<p>​		符号表</p>
<p>​		存放定义和引用全局变量和函数的信息</p>
<p>注：不是必须要使用-g选项在编译的时候才能显示出符号表，每一个.o文件都有一个符号表，只不过这两个符号表有些区别，就是.symtab没有局部变量。</p>
<p>8.rel.text节</p>
<p>​		.text节中的重定位信息</p>
<p>​		存放那些需要在可执行目标文件中被修改的指令地址信息</p>
<p>​		链接器在将这个文件和其他文件链接时，需要修改，尤其是当这个文件调用了其他文件中的函数或者引用了全局变量的时候，而调用本地函数，不需要修改。</p>
<p>​		在链接之后的可执行文件中，它可能不存在了，因为他的使命在重定位完成之后就完了。</p>
<p>9.rel.data节</p>
<p>​		.data节中的重定位信息</p>
<p>​		在合并后的可执行文件中需要修改的数据所在的地址</p>
<p>​		如果全局变量的初值是一个全局变量地址或者外部定义的函数地址，都需要修改。</p>
<p>10.debug节</p>
<p>​		一个调试符号表，包含了局部变量，类型定义，全局变量等</p>
<p>​		调试使用的符号信息 (在gcc中使用-g选项生成)</p>
<p>（补充）.line节</p>
<p>​		.c程序的行号和.text节中的指令的映射，需要-g选项才能得到。</p>
<p>（补充）.strtab节</p>
<p>​		字符串表，每个symtab和debug表项的名字。</p>
<p>11.节头部表</p>
<p>​		每个节的偏移量和大小</p>
<h2 id="符号和符号表"><a href="#符号和符号表" class="headerlink" title="符号和符号表"></a>符号和符号表</h2><p>每个可重定位目标模块都有符号表，而这个符号表中的表项有三种</p>
<p>1.全局符号</p>
<p>​		这个模块定义并能被其他模块引用</p>
<p>​		非static函数和非static全局变量</p>
<p>2.外部符号</p>
<p>​		其他模块定义，并被当前模块引用的全局符号</p>
<p>3.局部符号</p>
<p>​		当前模块定义的static的函数和static的全局变量，只能被当前模块引用的符号</p>
<p>​		补充:局部变量不会在.symtab中体现，它们在运行时的栈中被管理，因此，链接器也对它们不感兴趣。如果是static的局部变量，那么也可以显示。</p>
<p><img src="https://frun1na.netlify.app/20240919125015.png"></p>
<p>如图所示，链接器看不到局部变量。</p>
<h3 id="符号表结构"><a href="#符号表结构" class="headerlink" title="符号表结构"></a><strong>符号表结构</strong></h3><p>.symtab节中包含了符号表，他是由汇编器构造的。</p>
<p>如图所示的定义类型，他包含了符号表每个条目的信息。这样的一个数组，就构成了符号表，如下图所示。</p>
<p><img src="https://frun1na.netlify.app/20240919125147.png"></p>
<p>name表示这个符号的名字，在.strtab的偏移量，他指向一个字符串。</p>
<p>value指这个符号，在定义他自己的节里面距离节的起始位置的偏移量。如果这是一个可执行文件，那么value就代表绝对的地址值。</p>
<p>size是大小，以字节为单位</p>
<p>type表示类型，通常要么是函数，要么是数据。而且还有其他的表项，对应其他的类型。</p>
<p>binding表示该符号是本地的还是全局的。</p>
<p>不要忘了，每个符号都在elf文件中的某个节，而这个节就是用的section表示，他是一个节头部表的表项索引，告诉你这是哪个节。</p>
<p>有三个特殊的伪节，它们在节头表中没有条目:ABS表示不被重定位，UNDEF表示未定义（在本模块引用，但在其他模块定义），COMMON表示未初始化，它的size是最小的大小。</p>
<p>你可能会奇怪，按理说未初始化的应该在.bss里面，但是它们还是有一点区别的。</p>
<p>COMMON 				未初始化全局变量</p>
<p>.bss 							未初始化静态变量，初始化为0的全局或静态</p>
<p>这种分类是因为符号解析的方式。</p>
<p>下图是通过readelf指令读出的符号表。</p>
<p><img src="https://frun1na.netlify.app/20240919125625.png"></p>
<p>全局符号main，它是一个位于.text节（Ndx &#x3D; 0）中偏移量 为0(即value值)处的24 字节函数。其后是全局符号array的定义，它是一个位 于.data 节中偏移量为 0处的 8字节目标。最后一个条目来自对外部符号sum的引用。这里Ndx&#x3D;1表示.text节，而Ndx&#x3D;3表示.data节。</p>
<h2 id="符号解析"><a href="#符号解析" class="headerlink" title="符号解析"></a>符号解析</h2><p>链接器如何解析每个符号的引用情况？</p>
<p>将每一个引用，和他自己的symtab的定义对比，找到那一个表项。对于在引用和定义在一个模块的局部符号，这非常简单。</p>
<p>但是全局符号就非常麻烦了，当编译器遇到不是在当前模块定义的引用，就会生成一个symtab的条目，然后交给链接器。如果链接器没有在所有的模块中找到他，就会生成错误信息并终止。</p>
<blockquote>
<p><strong>旁注:为什么c++和java中允许函数重载？</strong></p>
<p><strong>名字相同，参数列表不同的函数，如何识别？因为编译器将每个函数名和它们的参数列表组合，编码成为一个对链接器来说唯一的名字，这种方法叫重整，相反的过程叫恢复。而且这个新名字就是原来的名字和数字，下划线组成的。</strong></p>
</blockquote>
<h3 id="多重定义的全局符号"><a href="#多重定义的全局符号" class="headerlink" title="多重定义的全局符号"></a>多重定义的全局符号</h3><p>全局符号包括强符号和弱符号</p>
<p>强符号		 函数和已初始化全局变量</p>
<p>弱符号		 未初始化全局变量</p>
<p>在链接时，如果出现符号同名</p>
<ul>
<li><p>规则1:不允许多个同名强符号</p>
</li>
<li><p>规则2:如果有一个强符号和多个弱符号同名 那么选择强符号</p>
</li>
<li><p>规则3:如果多个弱符号同名，那么随机选一个</p>
</li>
</ul>
<p>以下是可能出现的情况:</p>
<p><img src="https://frun1na.netlify.app//20240919212525.png"></p>
<p>这里第二行和第三行可能会有点难以理解，在x86-64&#x2F;linux系统上，double类型是8字节，int类型是4字节，在这个系统中，假设x的地址是0x601020，y的地址为0x601024，因此在p2中，将x的值写入，会将这个数的双精度浮点表示覆盖在x和y的位置。第二行中写可能是因为x和y都是弱符号，它们的定义可能在一块，而第三行，它们都是强符号，那么定义是在一块的。这个错误非常讨厌，而且一般是在很远的地方才表现出来。</p>
<p>那么我们可以使用选项</p>
<p>GCC -fno -common表示遇到多重定义符号时，变成一个错误。</p>
<p>或者直接-Werror将所有警告变成错误。</p>
<p>在上一节 我们知道了编译器将符号分配为COMMON和.bss，这到底是为什么了，这里不多说了。详细请看p474页中间。</p>
<p>不过最最根本的防止此类错误的方法，就是防止使用全局变量，尽量用static，就算用，那就要初始化它。如果在其他文件中使用此文件的全局变量，要用extern声明。</p>
<h3 id="与静态库连接"><a href="#与静态库连接" class="headerlink" title="与静态库连接"></a>与静态库连接</h3><p>编译器还提供了一种机制，将所有的相关的目标模块打包成为一个单独的文件，成为静态库（static library），它可以用作链接器的输入，当链接器构造可执行文件的时候，链接器可以仅仅复制目标程序引用的目标模块。</p>
<p>为什么要采用这种机制？当然是因为其他的机制都不行了，具体为什么不行，请看475页。</p>
<p>相关函数可以被编译为独立的一个个模块，封装成为静态库。然后，在命令行中指定文件的名字，以使用这些库中的函数。（这些静态库的后缀为.a，被称为存档文件）</p>
<p>在链接时，链接器只复制被引用的模块。</p>
<p>476，477页举了一个具体的例子。</p>
<h3 id="链接器如何使用静态库来解析引用"><a href="#链接器如何使用静态库来解析引用" class="headerlink" title="链接器如何使用静态库来解析引用"></a>链接器如何使用静态库来解析引用</h3><pre><code class="bash">gcc -static a.c b.c c.c d.a e.a  
</code></pre>
<p>-static表示生成可执行文件</p>
<p>在符号解析阶段，链接器从左到右地按照在控制台中的顺序扫描.o和.a文件（编译器自动将.c转化为.o文件），并维护三个集合：</p>
<ul>
<li>E：可重定位目标文件或模块</li>
<li>U：引用但未定义的符号</li>
<li>D：在前面已经定义的符号集合</li>
</ul>
<p>对于每一个输入文件f，首先判断是.o还是.a文件，如果是.o那就添加到E，并修改U和D。如果是.a，那就尝试和U中的元素匹配，匹配成功，就将目标模块加入E，修改U和D，直到U和D不再变化，然后丢弃没有匹配的部分，继续下一个。</p>
<p>如果完成全部扫描之后，U非空，就输出错误信息并终止。U空，就输出可执行文件。</p>
<p>不过，这种方式会导致一些错误，因为命令行里面的文件顺序就很重要了，如果先输入.a，再输入.c，那先输入的.a就会全部被抛弃，而.c也不能正常链接。</p>
<p>一般准则是把.a放在结尾，如果.a中也有互相调用的情况，也要调整顺序,同一个文件重复出现也是可以的。</p>
<pre><code class="bash">gcc foo.c la.a lb.a lc.a la.a
</code></pre>
<h2 id="重定位"><a href="#重定位" class="headerlink" title="重定位"></a>重定位</h2>
    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 Frun1na &#39;s blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Frun1na
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="Frun1na/Frun1na.github.io"
    data-repo-id="R_kgDOMv7m6Q"
    data-category="General"
    data-category-id="DIC_kwDOMv7m6c4CiZjQ"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





    
</body>
</html>
